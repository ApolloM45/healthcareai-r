context("Checking that data is selected correctly")

library(RODBC)
connection.string = '
driver={SQL Server};
server=localhost;
database=AdventureWorks2012;
trusted_connection=true'

query1 = '
SELECT
[OrganizationLevel]
FROM [AdventureWorks2012].[HumanResources].[Employee]'

query2 = '
select top 199 BirthDate from [AdventureWorks2012].[HumanResources].[Employee] order by BirthDate'

query3 = '
select top 0 BirthDate from [AdventureWorks2012].[HumanResources].[Employee] order by BirthDate'

query4 = '
select top 200 BirthDate from [AdventureWorks2012].[HumanResources].[Employee] order by BirthDate'

query5 = '
SELECT
[OrganizationLevel]
FROM [AdventureWorks2012].[HumanResources].[Addresss]'

test_that("Returns correct selected data in data frame", {
  expect_equal(SelectData(connection.string,query1),
               data.frame(OrganizationLevel=c(0,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,
                                              3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
                                              3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
                                              4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
                                              4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
                                              4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
                                              4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
                                              4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4)))
})

test_that("Returns too few rows message when <200 rows 199 rows edge case", {
  expect_equal(capture.output(SelectData(connection.string,query2)),
               capture.output(rbind(cat('Too few rows returned from SQL: 199 rows returned.Adjust your query to return more data!'),
               data.frame(BirthDate=c('1945-11-17','1946-04-03','1946-06-13','1946-10-29','1947-06-01','1948-05-25','1949-03-02','1950-02-16',
                                      '1950-04-27','1950-04-30','1950-05-03','1950-05-06','1950-07-06','1950-08-12','1950-09-08','1950-10-01',
                                      '1950-11-09','1951-10-22','1953-04-11','1953-08-29','1955-06-03','1956-09-29','1956-10-14','1956-10-14',
                                      '1958-01-11','1958-07-23','1960-12-30','1961-01-05','1961-01-08','1961-01-14','1961-01-17','1961-04-02',
                                      '1962-04-10','1962-04-18','1962-10-19','1963-01-26','1963-03-02','1963-10-19','1964-04-07','1964-05-05',
                                      '1964-05-29','1964-08-31','1964-11-18','1964-12-13','1964-12-25','1964-12-31','1965-01-03','1965-01-03',
                                      '1965-01-23','1965-02-04','1965-03-21','1965-04-09','1965-04-18','1965-07-14','1965-08-24','1965-09-01',
                                      '1965-09-27','1965-09-30','1965-10-03','1965-10-06','1965-10-12','1965-11-23','1966-01-17','1966-07-15',
                                      '1966-08-25','1966-10-11','1966-10-19','1966-12-27','1967-02-25','1967-07-05','1967-09-05','1967-09-28',
                                      '1967-09-30','1967-10-07','1967-12-13','1968-01-24','1968-02-19','1968-03-14','1968-06-03','1968-09-21',
                                      '1968-10-06','1968-10-11','1968-10-24','1968-11-16','1968-12-13','1968-12-16','1969-01-06','1969-01-23',
                                      '1969-02-11','1969-03-07','1969-04-17','1969-04-19','1969-06-17','1969-08-09','1969-10-31','1969-12-06',
                                      '1970-01-13','1970-01-21','1970-01-25','1970-02-04','1970-02-06','1970-02-06','1970-02-18','1970-03-02',
                                      '1970-03-13','1970-03-14','1970-03-14','1970-03-26','1970-04-07','1970-04-07','1970-04-19','1970-05-18',
                                      '1971-01-27','1971-02-11','1971-02-16','1971-03-07','1971-03-14','1971-03-18','1971-04-19','1971-04-28',
                                      '1971-05-08','1971-05-18','1971-05-19','1971-06-15','1971-07-08','1971-08-11','1971-10-15','1971-11-05',
                                      '1971-11-06','1971-11-27','1972-02-06','1972-02-18','1972-02-18','1972-02-27','1972-03-01','1972-03-01',
                                      '1972-03-13','1972-03-20','1972-03-28','1972-04-06','1972-06-07','1972-06-19','1972-07-01','1972-07-27',
                                      '1972-08-18','1973-02-21','1973-04-09','1973-04-29','1973-07-17','1973-07-19','1973-08-01','1973-08-02',
                                      '1973-08-06','1973-09-16','1973-10-26','1973-12-03','1974-03-30','1974-05-30','1974-06-29','1974-08-19',
                                      '1974-11-05','1974-12-15','1975-01-26','1975-06-29','1975-07-28','1975-09-04','1975-09-19','1975-12-08',
                                      '1976-02-04','1976-03-14','1976-04-24','1976-05-15','1976-07-28','1976-10-19','1976-12-04','1977-02-07',
                                      '1977-03-31','1977-05-03','1977-06-13','1977-07-23','1977-08-02','1977-08-08','1977-08-27','1977-11-19',
                                      '1977-11-20','1977-11-26','1978-04-26','1978-04-30','1978-05-13','1978-06-01','1978-08-26','1978-09-01',
                                      '1978-09-02','1978-09-12','1978-09-18','1978-09-26','1978-10-22','1978-11-12','1978-12-19')))))
})

test_that("Returns too few rows message when 0 rows edge case", {
  expect_equal(capture.output(SelectData(connection.string,query3)),
               capture.output(cbind(cat('Too few rows returned from SQL: 0 rows returned.Adjust your query to return more data!'),data.frame(BirthDate=character(),stringsAsFactors = FALSE))))
})

test_that("Returns coorect selected data in data frame 200 rows edge case", {
  expect_equal(SelectData(connection.string,query4),
               data.frame(BirthDate=c('1945-11-17','1946-04-03','1946-06-13','1946-10-29','1947-06-01','1948-05-25','1949-03-02','1950-02-16',
                                      '1950-04-27','1950-04-30','1950-05-03','1950-05-06','1950-07-06','1950-08-12','1950-09-08','1950-10-01',
                                      '1950-11-09','1951-10-22','1953-04-11','1953-08-29','1955-06-03','1956-09-29','1956-10-14','1956-10-14',
                                      '1958-01-11','1958-07-23','1960-12-30','1961-01-05','1961-01-08','1961-01-14','1961-01-17','1961-04-02',
                                      '1962-04-10','1962-04-18','1962-10-19','1963-01-26','1963-03-02','1963-10-19','1964-04-07','1964-05-05',
                                      '1964-05-29','1964-08-31','1964-11-18','1964-12-13','1964-12-25','1964-12-31','1965-01-03','1965-01-03',
                                      '1965-01-23','1965-02-04','1965-03-21','1965-04-09','1965-04-18','1965-07-14','1965-08-24','1965-09-01',
                                      '1965-09-27','1965-09-30','1965-10-03','1965-10-06','1965-10-12','1965-11-23','1966-01-17','1966-07-15',
                                      '1966-08-25','1966-10-11','1966-10-19','1966-12-27','1967-02-25','1967-07-05','1967-09-05','1967-09-28',
                                      '1967-09-30','1967-10-07','1967-12-13','1968-01-24','1968-02-19','1968-03-14','1968-06-03','1968-09-21',
                                      '1968-10-06','1968-10-11','1968-10-24','1968-11-16','1968-12-13','1968-12-16','1969-01-06','1969-01-23',
                                      '1969-02-11','1969-03-07','1969-04-17','1969-04-19','1969-06-17','1969-08-09','1969-10-31','1969-12-06',
                                      '1970-01-13','1970-01-21','1970-01-25','1970-02-04','1970-02-06','1970-02-06','1970-02-18','1970-03-02',
                                      '1970-03-13','1970-03-14','1970-03-14','1970-03-26','1970-04-07','1970-04-07','1970-04-19','1970-05-18',
                                      '1971-01-27','1971-02-11','1971-02-16','1971-03-07','1971-03-14','1971-03-18','1971-04-19','1971-04-28',
                                      '1971-05-08','1971-05-18','1971-05-19','1971-06-15','1971-07-08','1971-08-11','1971-10-15','1971-11-05',
                                      '1971-11-06','1971-11-27','1972-02-06','1972-02-18','1972-02-18','1972-02-27','1972-03-01','1972-03-01',
                                      '1972-03-13','1972-03-20','1972-03-28','1972-04-06','1972-06-07','1972-06-19','1972-07-01','1972-07-27',
                                      '1972-08-18','1973-02-21','1973-04-09','1973-04-29','1973-07-17','1973-07-19','1973-08-01','1973-08-02',
                                      '1973-08-06','1973-09-16','1973-10-26','1973-12-03','1974-03-30','1974-05-30','1974-06-29','1974-08-19',
                                      '1974-11-05','1974-12-15','1975-01-26','1975-06-29','1975-07-28','1975-09-04','1975-09-19','1975-12-08',
                                      '1976-02-04','1976-03-14','1976-04-24','1976-05-15','1976-07-28','1976-10-19','1976-12-04','1977-02-07',
                                      '1977-03-31','1977-05-03','1977-06-13','1977-07-23','1977-08-02','1977-08-08','1977-08-27','1977-11-19',
                                      '1977-11-20','1977-11-26','1978-04-26','1978-04-30','1978-05-13','1978-06-01','1978-08-26','1978-09-01',
                                      '1978-09-02','1978-09-12','1978-09-18','1978-09-26','1978-10-22','1978-11-12','1978-12-19','1978-12-20')))
})

test_that("Returns SQL error message when SQL error", {
  expect_error(capture.output(SelectData(connection.string,query5)),
               'Your SQL contains an error.')
})
